<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Private Chat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
  <h4 id="receiver"></h4>
  <div id="chatBox" class="border rounded bg-white p-3 mb-3" style="height: 65vh; overflow-y: auto;"></div>
  <form id="msgForm" class="d-flex">
    <input id="msgInput" class="form-control me-2" placeholder="Type message..." required>
    <button class="btn btn-success">Send</button>
  </form>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const username = params.get("to");
const baseUrl = `http://127.0.0.1:8000/api/private/${username}/messages/`;
const token = localStorage.getItem("authToken");

document.getElementById("receiver").textContent = "Chat with " + username;

const chatBox = document.getElementById("chatBox");
const socket = new WebSocket(`ws://127.0.0.1:8000/ws/private/${username}/`);

socket.onmessage = (e) => {
  const data = JSON.parse(e.data);
  const div = document.createElement("div");
  div.className = "mb-2";
  div.innerHTML = `<strong>${data.username}</strong>: ${data.message}`;
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
};

async function loadMessages() {
  const res = await fetch(baseUrl, { headers: { Authorization: `Bearer ${token}` }});
  const data = await res.json();
  data.forEach(m => {
    chatBox.innerHTML += `<div><strong>${m.sender.username}</strong>: ${m.content}</div>`;
  });
  chatBox.scrollTop = chatBox.scrollHeight;
}

document.getElementById("msgForm").addEventListener("submit", e => {
  e.preventDefault();
  const msg = msgInput.value.trim();
  if (msg) {
    socket.send(JSON.stringify({ message: msg }));
    msgInput.value = "";
  }
});

loadMessages();
</script>
</body>
</html>
