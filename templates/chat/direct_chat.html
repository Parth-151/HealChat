{% extends 'chat_base.html' %}
{% block chat %}
<div class="card">
  <div class="card-header"><h5>Chat with {{ other_user.username }}</h5></div>
  <div id="messages" style="height:60vh;overflow:auto;padding:18px;">
    {% for m in messages %}
      <div class="mb-2 {% if m.sender == request.user %}text-end{% endif %}">
        <div class="{% if m.sender == request.user %}msg-right{% else %}msg-left{% endif %}">
          <strong>{{ m.sender.username }}</strong><br>{{ m.content|linebreaksbr }}
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="card-footer">
    <div class="input-group">
      <input id="msgInput" class="form-control" placeholder="Type a message...">
      <button id="sendBtn" class="btn btn-primary">Send</button>
    </div>
  </div>
</div>

<script>
const other = "{{ other_user.username }}";
const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
const url = `${wsScheme}://${window.location.host}/ws/direct/${other}/`;
const sock = new WebSocket(url);

sock.onmessage = (ev) => {
  const d = JSON.parse(ev.data);
  const messagesDiv = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "mb-2";
  div.innerHTML = `<div class="msg-left"><strong>${d.sender}</strong><br>${d.message}</div>`;

  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
};

document.getElementById("sendBtn").onclick = () => {
  const input = document.getElementById("msgInput");
  const v = input.value.trim();
  if (!v) return;
  sock.send(JSON.stringify({message: v}));
  input.value = "";
};
</script>
{% endblock %}
