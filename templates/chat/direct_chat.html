{% extends "chat_base.html" %}
{% block chat_area %}
<div class="topbar">
  <img src="{{ other_user.profile.get_avatar_url }}">
  <div style="margin-left:10px"><b>{{ other_user.username }}</b><br><small style="color:var(--muted)">Online</small></div>
</div>

<div class="messages" id="messages">
  {% for msg in messages %}
    <div class="msg {% if msg.sender == request.user %}right{% else %}left{% endif %}">
      <strong>{{ msg.sender.username }}</strong>: {{ msg.content }}
    </div>
  {% endfor %}
</div>

<div class="composer">
  <input id="msgBox" placeholder="Write Something..." autocomplete="off">
  <button class="sendbtn" id="sendBtn">âž¤</button>
</div>

<script>
const username = "{{ other_user.username }}";
const socket = new WebSocket(`ws://${window.location.host}/ws/chat/${username}/`);

socket.onmessage = function(e){
  const data = JSON.parse(e.data);
  const messages = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = data.sender === "{{ request.user.username }}" ? "msg right" : "msg left";
  div.innerHTML = `<strong>${data.sender}</strong>: ${data.message}`;
  messages.appendChild(div);
  messages.scrollTop = messages.scrollHeight;
};

document.getElementById("sendBtn").onclick = ()=>{
  const input = document.getElementById("msgBox");
  if(input.value.trim()){
    socket.send(JSON.stringify({message: input.value}));
    input.value = '';
  }
};
</script>
{% endblock %}
