{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* Chat Specific Styles */
    :root { --brand: #6c5ce7; --bot-bg: #f1f5f9; --user-bg: #6c5ce7; }
    
    .chat-wrapper {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #fff;
        /* Fix for mobile to prevent hidden input */
        position: absolute; 
        top: 0; bottom: 0; left: 0; right: 0;
    }

    .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-bottom: 80px; /* Space for composer */
    }

    /* Mood Bar */
    .mood-bar {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 10px;
        overflow-x: auto;
        white-space: nowrap;
        background: #fff;
        flex-shrink: 0;
    }
    .mood-btn {
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
        padding: 5px;
    }
    .mood-btn:hover { transform: scale(1.2); }

    /* Bubbles */
    .bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.5;
        font-size: 0.95rem;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
    }
    .bubble.user {
        align-self: flex-end;
        background: var(--user-bg);
        color: white;
        border-bottom-right-radius: 4px;
    }
    .bubble.bot {
        align-self: flex-start;
        background: var(--bot-bg);
        color: #1e293b;
        border-bottom-left-radius: 4px;
    }

    /* Composer */
    .composer {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: #fff;
        /* Stick to bottom */
        position: sticky;
        bottom: 0;
    }
    .composer input {
        flex: 1;
        padding: 12px;
        border-radius: 25px;
        border: 1px solid #ddd;
        outline: none;
    }
    .composer button {
        background: var(--brand);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0 20px;
        font-weight: 600;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="modal fade" id="emergencyModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger border-2">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Wellness Check</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h4>Are you okay?</h4>
                <p>It sounds like you are going through a tough time. We strongly recommend connecting with someone who can help.</p>
                
                <div id="contactInfoSection" class="alert alert-warning d-none shadow-sm text-start">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted text-uppercase fw-bold">Your Emergency Contact</small><br>
                            <strong id="contactName" class="fs-5"></strong>
                        </div>
                        <a id="contactPhone" href="" class="btn btn-success btn-lg">
                            <i class="bi bi-telephone-fill"></i> Call
                        </a>
                    </div>
                </div>

                <hr>

                <p class="mb-2 small text-muted">Or call a verified helpline:</p>
                <div class="d-grid gap-2">
                    <a href="tel:14416" class="btn btn-outline-primary fw-bold text-start p-3 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-heart-pulse-fill"></i> Tele-MANAS (Mental Health)</span>
                        <span>14416</span>
                    </a>
                    
                    <a href="tel:108" class="btn btn-outline-danger fw-bold text-start p-3 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-ambulance"></i> Ambulance Service</span>
                        <span>108</span>
                    </a>

                    <a href="tel:112" class="btn btn-outline-dark fw-bold text-start p-3 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-shield-fill-exclamation"></i> National Emergency</span>
                        <span>112</span>
                    </a>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">I am safe, continue chat</button>
            </div>
        </div>
    </div>
</div>
<div class="chat-wrapper">
    <div class="mood-bar">
        <span class="mood-btn" data-mood="I'm feeling Happy ðŸ˜Š" title="Happy">ðŸ˜Š</span>
        <span class="mood-btn" data-mood="I'm feeling Sad ðŸ˜¢" title="Sad">ðŸ˜¢</span>
        <span class="mood-btn" data-mood="I'm feeling Angry ðŸ˜¡" title="Angry">ðŸ˜¡</span>
        <span class="mood-btn" data-mood="I'm feeling Stressed ðŸ˜°" title="Stressed">ðŸ˜°</span>
        <span class="mood-btn" data-mood="I'm feeling Lonely ðŸ˜­" title="Lonely">ðŸ˜­</span>
        <span class="mood-btn" data-mood="I'm feeling Confused ðŸ¤”" title="Confused">ðŸ¤”</span>
        <span class="mood-btn" data-mood="I'm feeling Overwhelmed ðŸ¤¯" title="Overwhelmed">ðŸ¤¯</span>
        <span class="mood-btn" data-mood="I'm feeling Calm ðŸ˜‡" title="Calm">ðŸ˜‡</span>
    </div>

    <div class="chat-window" id="aiChatBox">
        <div class="bubble bot">
            Hello {{ request.user.username }}! ðŸ‘‹ I'm your AI companion. How are you feeling right now?
        </div>
    </div>

    <div class="composer">
        <input type="text" id="aiInput" placeholder="Type your thoughts here..." autocomplete="off">
        <button id="aiSendBtn">Send</button>
    </div>
</div>

<script>
    // --- 1. CSRF Token Helper ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- 2. Chat Logic ---
    const chatBox = document.getElementById('aiChatBox');
    const input = document.getElementById('aiInput');
    const btn = document.getElementById('aiSendBtn');

    function addBubble(text, sender) {
        const div = document.createElement('div');
        div.className = `bubble ${sender}`;
        // USE INNERHTML to preserve line breaks
        div.innerHTML = text.replace(/\n/g, '<br>'); 
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function loadHistory() {
        try {
            const res = await fetch("/api/chatbot/api/chat/");
            const data = await res.json();
            data.forEach(msg => {
                addBubble(msg.message, 'user');
                if(msg.response) addBubble(msg.response, 'bot');
            });
            // Scroll to bottom once loaded
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch(err) {
            console.error("History load error", err);
        }
    }
    loadHistory(); 

    async function sendMessage(msg) {
        addBubble(msg, 'user');
        
        // Typing indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'bubble bot';
        loadingDiv.innerText = '...';
        loadingDiv.id = 'typing';
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const res = await fetch("/api/chatbot/api/chat/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ user_message: msg }),
            });
            
            const data = await res.json();
            
            document.getElementById('typing').remove();
            
            if(data.response) {
                addBubble(data.response, 'bot');
            }
            
            // --- NEW: EMERGENCY CHECK ---
            if (data.emergency_trigger === true) {
                showEmergencyModal(data.emergency_contact);
            }

        } catch(err) {
            const typer = document.getElementById('typing');
            if(typer) typer.remove();
            addBubble("âš ï¸ Network error. Please try again.", 'bot');
        }
    }

    // --- 3. Emergency Modal Logic ---
    function showEmergencyModal(contact) {
        const modal = new bootstrap.Modal(document.getElementById('emergencyModal'));
        
        if (contact) {
            document.getElementById("contactInfoSection").classList.remove("d-none");
            document.getElementById("contactName").innerText = contact.name;
            document.getElementById("contactPhone").href = `tel:${contact.phone}`;
        }
        modal.show();
    }

    // Event Listeners
    btn.addEventListener('click', () => {
        const txt = input.value.trim();
        if(txt) {
            sendMessage(txt);
            input.value = '';
        }
    });

    input.addEventListener('keyup', (e) => {
        if(e.key === 'Enter') btn.click();
    });

    document.querySelectorAll('.mood-btn').forEach(b => {
        b.addEventListener('click', function() {
            const msg = this.getAttribute('data-mood');
            sendMessage(msg);
        });
    });
</script>
{% endblock %}