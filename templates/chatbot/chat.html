{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* Chat Specific Styles overriding/adding to Base */
    :root { --brand: #6c5ce7; --bot-bg: #f1f5f9; --user-bg: #6c5ce7; }
    
    .chat-wrapper {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Mood Bar */
    .mood-bar {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 10px;
        overflow-x: auto;
        white-space: nowrap;
        background: #fff;
    }
    .mood-btn {
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
        padding: 5px;
    }
    .mood-btn:hover { transform: scale(1.2); }

    /* Bubbles */
    .bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.5;
        font-size: 0.95rem;
        animation: fadeIn 0.3s ease;
    }
    .bubble.user {
        align-self: flex-end;
        background: var(--user-bg);
        color: white;
        border-bottom-right-radius: 4px;
    }
    .bubble.bot {
        align-self: flex-start;
        background: var(--bot-bg);
        color: #1e293b;
        border-bottom-left-radius: 4px;
    }

    /* Composer */
    .composer {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: #fff;
    }
    .composer input {
        flex: 1;
        padding: 12px;
        border-radius: 25px;
        border: 1px solid #ddd;
        outline: none;
    }
    .composer button {
        background: var(--brand);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0 20px;
        font-weight: 600;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>

<div class="chat-wrapper">
    <div class="mood-bar">
        <span class="mood-btn" data-mood="I'm feeling Happy ðŸ˜Š" title="Happy">ðŸ˜Š</span>
        <span class="mood-btn" data-mood="I'm feeling Sad ðŸ˜¢" title="Sad">ðŸ˜¢</span>
        <span class="mood-btn" data-mood="I'm feeling Angry ðŸ˜¡" title="Angry">ðŸ˜¡</span>
        <span class="mood-btn" data-mood="I'm feeling Stressed ðŸ˜°" title="Stressed">ðŸ˜°</span>
        <span class="mood-btn" data-mood="I'm feeling Lonely ðŸ˜­" title="Lonely">ðŸ˜­</span>
        <span class="mood-btn" data-mood="I'm feeling Confused ðŸ¤”" title="Confused">ðŸ¤”</span>
        <span class="mood-btn" data-mood="I'm feeling Overwhelmed ðŸ¤¯" title="Overwhelmed">ðŸ¤¯</span>
        <span class="mood-btn" data-mood="I'm feeling Calm ðŸ˜‡" title="Calm">ðŸ˜‡</span>
    </div>

    <div class="chat-window" id="aiChatBox">
        <div class="bubble bot">
            Hello {{ request.user.username }}! ðŸ‘‹ I'm your AI companion. How are you feeling right now?
        </div>
    </div>

    <div class="composer">
        <input type="text" id="aiInput" placeholder="Type your thoughts here..." autocomplete="off">
        <button id="aiSendBtn">Send</button>
    </div>
</div>

<script>
    // --- 1. CSRF Token Helper (Crucial for Django AJAX) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- 2. Chat Logic ---
    const chatBox = document.getElementById('aiChatBox');
    const input = document.getElementById('aiInput');
    const btn = document.getElementById('aiSendBtn');

    function addBubble(text, sender) {
        const div = document.createElement('div');
        div.className = `bubble ${sender}`;
        div.innerText = text;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function loadHistory() {
        try {
            const res = await fetch("/api/chatbot/api/chat/"); // Note the URL
            const data = await res.json();
            data.forEach(msg => {
                addBubble(msg.message, 'user');
                if(msg.response) addBubble(msg.response, 'bot');
            });
        } catch(err) {
            console.error("History load error", err);
        }
    }
    loadHistory(); // Run on load

    async function sendMessage(msg) {
        addBubble(msg, 'user');
        
        // Show typing indicator (optional)
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'bubble bot';
        loadingDiv.innerText = '...';
        loadingDiv.id = 'typing';
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const res = await fetch("/api/chatbot/api/chat/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken // This replaces the JWT Header
                },
                body: JSON.stringify({ user_message: msg }),
            });
            
            const data = await res.json();
            
            // Remove typing indicator
            document.getElementById('typing').remove();
            
            if(data.response) {
                addBubble(data.response, 'bot');
            } else {
                addBubble("Sorry, I couldn't process that.", 'bot');
            }
        } catch(err) {
            const typer = document.getElementById('typing');
            if(typer) typer.remove();
            addBubble("âš ï¸ Network error. Please try again.", 'bot');
        }
    }

    // Event Listeners
    btn.addEventListener('click', () => {
        const txt = input.value.trim();
        if(txt) {
            sendMessage(txt);
            input.value = '';
        }
    });

    input.addEventListener('keyup', (e) => {
        if(e.key === 'Enter') btn.click();
    });

    // Mood Buttons
    document.querySelectorAll('.mood-btn').forEach(b => {
        b.addEventListener('click', function() {
            const msg = this.getAttribute('data-mood');
            sendMessage(msg);
        });
    });
</script>
{% endblock %}