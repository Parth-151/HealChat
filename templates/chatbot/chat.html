{% extends 'base.html' %}
{% load static %}

{% block content %}
<style>
    /* Chat Specific Styles */
    :root { --brand: #6c5ce7; --bot-bg: #f1f5f9; --user-bg: #6c5ce7; }
    
    .chat-wrapper {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: #fff;
        position: absolute; 
        top: 0; bottom: 0; left: 0; right: 0;
    }

    .chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-bottom: 80px;
    }

    /* Mood Bar */
    .mood-bar {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 10px;
        overflow-x: auto;
        white-space: nowrap;
        background: #fff;
        flex-shrink: 0;
        justify-content: space-evenly;
    }
    .mood-btn {
        font-size: 1.5rem;
        cursor: pointer;
        transition: transform 0.2s;
        padding: 5px;
    }
    .mood-btn:hover { transform: scale(1.2); }

    /* Bubbles */
    .bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.5;
        font-size: 0.95rem;
        animation: fadeIn 0.3s ease;
        word-wrap: break-word;
    }
    .bubble.user {
        align-self: flex-end;
        background: var(--user-bg);
        color: white;
        border-bottom-right-radius: 4px;
    }
    .bubble.bot {
        align-self: flex-start;
        background: var(--bot-bg);
        color: #1e293b;
        border-bottom-left-radius: 4px;
    }

    /* Composer with Mic */
    .composer {
        padding: 15px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        background: #fff;
        position: sticky;
        bottom: 0;
        align-items: center;
    }
    .composer input {
        flex: 1;
        padding: 12px;
        border-radius: 25px;
        border: 1px solid #ddd;
        outline: none;
    }
    .composer button {
        background: var(--brand);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0 20px;
        font-weight: 600;
        height: 45px;
    }
    
    /* New Mic Button Style */
    #micBtn {
        background: #ff9f43; /* Orange for Mic */
        width: 45px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    #micBtn.listening {
        background: #ef4444; /* Red when recording */
        animation: pulse 1.5s infinite;
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    /* Add this to chat.html styles */
.typing-indicator {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    background: #f1f5f9;
    border-radius: 18px;
    border-bottom-left-radius: 4px;
    width: fit-content;
}
.dot {
    width: 8px;
    height: 8px;
    background-color: #94a3b8;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out both;
}
.dot:nth-child(1) { animation-delay: -0.32s; }
.dot:nth-child(2) { animation-delay: -0.16s; }
@keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
}
</style>

<div class="modal fade" id="emergencyModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger border-2">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill"></i> Wellness Check</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <h4>Are you okay?</h4>
                <p>It sounds like you are going through a tough time. We strongly recommend connecting with someone who can help.</p>
                
                <div id="contactInfoSection" class="alert alert-warning d-none shadow-sm text-start">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted text-uppercase fw-bold">Your Emergency Contact</small><br>
                            <strong id="contactName" class="fs-5"></strong>
                        </div>
                        <a id="contactPhone" href="" class="btn btn-success btn-lg">
                            <i class="bi bi-telephone-fill"></i> Call
                        </a>
                    </div>
                </div>

                <hr>
                <p class="mb-2 small text-muted">Or call a verified helpline:</p>
                <div class="d-grid gap-2">
                    <a href="tel:14416" class="btn btn-outline-primary fw-bold text-start p-3 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-heart-pulse-fill"></i> Tele-MANAS</span><span>14416</span>
                    </a>
                    <a href="tel:108" class="btn btn-outline-danger fw-bold text-start p-3 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-ambulance"></i> Ambulance</span><span>108</span>
                    </a>
                    <a href="tel:112" class="btn btn-outline-dark fw-bold text-start p-3 d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-shield-fill-exclamation"></i> Emergency</span><span>112</span>
                    </a>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">I am safe, continue chat</button>
            </div>
        </div>
    </div>
</div>

<div class="chat-wrapper">
    <div class="mood-bar">
        <select id="langSelect" class="form-select form-select-sm" style="width: auto; border-radius: 20px;">
            <option value="en-IN">English</option>
            <option value="hi-IN">Hindi</option>
            <option value="gu-IN">Gujarati</option>
        </select>
        
        <span class="mood-btn" data-mood="Happy üòä" title="Happy">üòä</span>
        <span class="mood-btn" data-mood="Sad üò¢" title="Sad">üò¢</span>
        <span class="mood-btn" data-mood="Angry üò°" title="Angry">üò°</span>
        <span class="mood-btn" data-mood="Stressed üò∞" title="Stressed">üò∞</span>
        <span class="mood-btn" data-mood="Calm üòá" title="Calm">üòá</span>
        <span class="mood-btn" data-mood="I feel Confused ü§î" title="Confused">ü§î</span>
        <span class="mood-btn" data-mood="I feel Tired üò¥" title="Tired">üò¥</span>
        <span class="mood-btn" data-mood="I feel Lonely üòî" title="Lonely">üòî</span>
        <span class="mood-btn" data-mood="I feel Excited ü§©" title="Excited">ü§©</span>
        <span class="mood-btn" data-mood="I feel Numb üò∂" title="Numb">üò∂</span>
        <span class="mood-btn" data-mood="I feel Grateful üôè" title="Grateful">üôè</span>
        <span class="mood-btn" data-mood="I feel Hopeful ü§û" title="Hopeful">ü§û</span>
    </div>

    <div class="chat-window" id="aiChatBox">
    <div id="emptyState" class="text-center mt-5 pt-5">
        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
            <i class="bi bi-robot fs-1 text-primary"></i>
        </div>
        <h4 class="fw-bold text-dark">HealChat AI</h4>
        <p class="text-muted">I'm here to listen. Tell me how you're feeling.</p>
        <div class="d-flex justify-content-center gap-2 mt-3">
            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="sendMessage('I feel anxious')">I feel anxious</button>
            <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="sendMessage('I cannot sleep')">I can't sleep</button>
        </div>
    </div>
</div>

    <div class="composer">
        <button id="micBtn" onclick="toggleSpeech()" title="Speak"><i class="bi bi-mic-fill"></i></button>
        
        <input type="text" id="aiInput" placeholder="Type or speak..." autocomplete="off">
        <button id="aiSendBtn"><i class="bi bi-send-fill"></i></button>
    </div>
</div>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const chatBox = document.getElementById('aiChatBox');
    const input = document.getElementById('aiInput');
    const btn = document.getElementById('aiSendBtn');
    const micBtn = document.getElementById('micBtn');
    const langSelect = document.getElementById('langSelect');

    const micButton = document.getElementById("micBtn");
    const voiceInput = document.getElementById("aiInput"); 

    let recognition = null;
    let listening = false;

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.interimResults = false;
        recognition.continuous = false;

        recognition.lang = langSelect ? langSelect.value : 'en-IN';

        recognition.onstart = () => {
            listening = true;
            micButton.classList.add("listening");
            micButton.innerHTML = '<i class="bi bi-stop-circle-fill"></i>'; 
            micButton.title = "Stop Recording";
        };

        recognition.onresult = (event) => {
            const spoken = event.results[0][0].transcript;
            if(voiceInput) voiceInput.value = spoken;
        };

        recognition.onend = () => {
            stopSpeech();
        };

        recognition.onerror = (event) => {
            if (event.error !== 'no-speech') {
                console.error("Voice Error:", event.error);
            }
            stopSpeech();
        };
    } else {
        if(micButton) micButton.style.display = 'none';
    }

    function toggleSpeech() {
        if (!recognition) return;
        
        if (!listening) {
            if(langSelect) recognition.lang = langSelect.value;
            recognition.start();
        } else {
            recognition.stop();
        }
    }

    function stopSpeech() {
        listening = false;
        if(micButton) {
            micButton.classList.remove("listening");
            micButton.innerHTML = '<i class="bi bi-mic-fill"></i>'; 
            micButton.title = "Speak";
        }
    }
    
    if(micButton) micButton.onclick = toggleSpeech;
    function addBubble(text, sender) {
    const emptyState = document.getElementById('emptyState');
    if (emptyState) emptyState.style.display = 'none';
        const div = document.createElement('div');
        div.className = `bubble ${sender}`;
        div.innerHTML = text.replace(/\n/g, '<br>'); 
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function loadHistory() {
        try {
            const res = await fetch("/api/chatbot/api/chat/");
            const data = await res.json();
            data.forEach(msg => {
                addBubble(msg.message, 'user');
                if(msg.response) addBubble(msg.response, 'bot');
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        } catch(err) {
            console.error("History error", err);
        }
    }
    loadHistory(); 

    async function sendMessage(msg) {
        addBubble(msg, 'user');
        
        

const loadingDiv = document.createElement('div');
loadingDiv.id = 'typing';
loadingDiv.className = 'mb-2'; 
loadingDiv.innerHTML = `
    <div class="typing-indicator">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>`;
chatBox.appendChild(loadingDiv);
chatBox.scrollTop = chatBox.scrollHeight;


        try {
            const res = await fetch("/api/chatbot/api/chat/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrftoken
                },
                body: JSON.stringify({ user_message: msg }),
            });
            
            const data = await res.json();
            document.getElementById('typing').remove();
            
            if(data.response) {
                addBubble(data.response, 'bot');
            }
            
            if (data.emergency_trigger === true) {
                showEmergencyModal(data.emergency_contact);
            }

        } catch(err) {
            const typer = document.getElementById('typing');
            if(typer) typer.remove();
            addBubble("‚ö†Ô∏è Network error.", 'bot');
        }
    }

    function showEmergencyModal(contact) {
        const modalEl = document.getElementById('emergencyModal');
        
        if (modalEl.parentElement !== document.body) {
            document.body.appendChild(modalEl);
        }

        const modal = new bootstrap.Modal(modalEl);
        
        if (contact) {
            document.getElementById("contactInfoSection").classList.remove("d-none");
            document.getElementById("contactName").innerText = contact.name;
            document.getElementById("contactPhone").href = `tel:${contact.phone}`;
        }
        modal.show();
    }

    btn.addEventListener('click', () => {
        const txt = input.value.trim();
        if(txt) {
            sendMessage(txt);
            input.value = '';
        }
    });

    input.addEventListener('keyup', (e) => {
        if(e.key === 'Enter') btn.click();
    });

    document.querySelectorAll('.mood-btn').forEach(b => {
        b.addEventListener('click', function() {
            const msg = this.getAttribute('data-mood');
            sendMessage(msg);
        });
    });
</script>
{% endblock %}