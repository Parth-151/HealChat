{% extends 'base.html' %}

{% block content %}
<style>
    .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
    .chat-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; background: #fff; }
    .messages-area { flex: 1; padding: 20px; overflow-y: auto; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
    
    .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; position: relative; font-size: 0.95rem; }
    .msg-received { background: #f0f2f5; align-self: flex-start; border-bottom-left-radius: 2px; }
    .msg-sent { background: #6c5ce7; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
    
    .chat-input-area { padding: 15px; background: white; border-top: 1px solid #eee; }
    .sender-name { font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; color: #555; }
</style>

<div class="chat-container">
    <div class="chat-header shadow-sm">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'group:group_profile' group.slug %}" class="d-flex align-items-center gap-3 text-decoration-none text-dark">
                <div class="rounded-circle p-1 border">
                    <img src="{{ group.get_icon_url }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                </div>
                <div>
                    <h5 class="m-0 fw-bold">{{ group.name }}</h5>
                    <small class="text-muted">{{ group.members.count }} members</small>
                </div>
            </a>
        </div>
    </div>

    <div class="messages-area d-flex flex-column" id="chat-box">
        {% for m in chat_messages %}
            <div class="message-bubble {% if m.sender == request.user %}msg-sent{% else %}msg-received{% endif %}">
                {% if m.sender != request.user %}
                    <a href="{% url 'users:profile' m.sender.username %}" class="sender-name text-decoration-none">
                        {{ m.sender.username }}
                    </a>
                {% endif %}
                {{ m.content|linebreaksbr }}
                <div class="text-end opacity-75" style="font-size: 0.7rem; margin-top: 4px;">
                    {{ m.timestamp|date:"H:i" }}
                </div>
            </div>
        {% empty %}
            <div class="text-center text-muted mt-5">
                <i class="bi bi-chat-square-dots fs-1"></i>
                <p>No messages yet. Start the conversation!</p>
            </div>
        {% endfor %}
    </div>

    {% if is_member %}
    <div class="chat-input-area">
        <div class="input-group">
            <input type="text" id="msgInput" class="form-control border-0 bg-light" placeholder="Type a message..." style="padding: 12px;">
            <button id="sendBtn" class="btn btn-primary px-4"><i class="bi bi-send-fill"></i></button>
        </div>
    </div>
    {% endif %}
</div>

<script>
    const slug = "{{ group.slug }}";
    const currentUser = "{{ request.user.username }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${wsScheme}://${window.location.host}/ws/groups/${slug}/`;
    
    const socket = new WebSocket(wsUrl);
    const chatBox = document.getElementById("chat-box");

    // Auto scroll to bottom
    chatBox.scrollTop = chatBox.scrollHeight;

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const isMe = data.sender === currentUser;
        
        const div = document.createElement("div");
        div.className = `message-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
        
        let html = "";
        if (!isMe) {
            html += `<div class="sender-name">${data.sender}</div>`;
        }
        html += `${data.message.replace(/\n/g, '<br>')}`;
        html += `<div class="text-end opacity-75" style="font-size: 0.7rem; margin-top: 4px;">Now</div>`;
        
        div.innerHTML = html;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    const input = document.getElementById("msgInput");
    const btn = document.getElementById("sendBtn");

    if(btn) {
        btn.onclick = sendMessage;
        input.onkeyup = function(e) {
            if (e.keyCode === 13) sendMessage();
        };
    }

    function sendMessage() {
        const message = input.value.trim();
        if (message) {
            socket.send(JSON.stringify({ 'message': message }));
            input.value = '';
        }
    }
</script>
{% endblock %}