{% extends 'base.html' %}

{% block content %}
<style>
    .chat-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; }
    .chat-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; background: #fff; }
    .messages-area { flex: 1; padding: 20px; overflow-y: auto; background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
    
    .message-bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; position: relative; font-size: 0.95rem; }
    .msg-received { background: #f0f2f5; align-self: flex-start; border-bottom-left-radius: 2px; }
    .msg-sent { background: #6c5ce7; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
    
    .chat-input-area { padding: 15px; background: white; border-top: 1px solid #eee; }
    .sender-name { font-size: 0.75rem; margin-bottom: 4px; font-weight: 600; color: #555; }
   
#micBtn {
    background: #ff9f43; /* Orange */
    border: none;
    color: white;
    width: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    transition: all 0.3s ease;
}
#micBtn:hover { background: #e67e22; }
#micBtn.listening {
    background: #ef4444; /* Red */
    animation: pulse 1.5s infinite;
}
#anonBtn.active {
    background-color: #343a40; /* Dark color for anonymous */
    color: white;
}
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
</style>

<div class="chat-container">
    <div class="chat-header shadow-sm">
        <div class="d-flex align-items-center gap-3">
            <a href="{% url 'group:group_profile' group.slug %}" class="d-flex align-items-center gap-3 text-decoration-none text-dark">
                <div class="rounded-circle p-1 border">
                    <img src="{{ group.get_icon_url }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                </div>
                <div>
                    <h5 class="m-0 fw-bold">{{ group.name }}</h5>
                    <small class="text-muted">{{ group.members.count }} members</small>
                </div>
            </a>
        </div>
    </div>

    <div class="messages-area d-flex flex-column" id="chat-box">
        {% for m in chat_messages %}
    <div class="message-bubble {% if m.sender == request.user %}msg-sent{% else %}msg-received{% endif %}">
        
        {% if m.sender != request.user %}
            {% if m.is_anonymous %}
                <div class="sender-name text-muted">
                    <i class="bi bi-incognito"></i> Anonymous
                </div>
            {% else %}
                <a href="{% url 'users:profile' m.sender.username %}" class="sender-name text-decoration-none">
                    {{ m.sender.username }}
                </a>
            {% endif %}
        {% else %}
            {% if m.is_anonymous %}
                <div class="d-flex align-items-center gap-1 mb-1" style="font-size: 0.75rem; opacity: 0.9; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 2px;">
                    <i class="bi bi-eye-slash-fill"></i> <strong>You (Anonymous)</strong>
                </div>
            {% endif %}
        {% endif %}

        {{ m.content|linebreaksbr }}
        
        <div class="text-end opacity-75" style="font-size: 0.7rem; margin-top: 4px;">
            {{ m.timestamp|date:"H:i" }}
        </div>
    </div>
{% endfor %}
    </div>

    {% if is_member %}
    <div class="chat-input-area">
    <div class="input-group">
        <button class="btn" type="button" id="micBtn" onclick="toggleSpeech()">
            <i class="bi bi-mic-fill"></i>
        </button>

        <button class="btn btn-light border" type="button" id="anonBtn" onclick="toggleAnon()" title="Go Anonymous">
            <i class="bi bi-eye-fill" id="anonIcon"></i>
        </button>
        
        <input type="text" id="msgInput" class="form-control border-0 bg-light" placeholder="Type a message..." style="padding: 12px;">
        <button id="sendBtn" class="btn btn-primary px-4"><i class="bi bi-send-fill"></i></button>
    </div>
</div>
</div>
    {% endif %}
</div>
<script>
    // --- CONFIGURATION ---
    const slug = "{{ group.slug }}";
    const currentUser = "{{ request.user.username }}";
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = `${wsScheme}://${window.location.host}/ws/groups/${slug}/`;
    
    // --- ELEMENTS ---
    const socket = new WebSocket(wsUrl);
    const chatBox = document.getElementById("chat-box");
    const input = document.getElementById("msgInput");
    const btn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");
    const anonBtn = document.getElementById('anonBtn');
    const anonIcon = document.getElementById('anonIcon');

    // --- STATE ---
    let isAnonymous = false;
    let recognition = null;
    let listening = false;

    // Scroll to bottom on load
    chatBox.scrollTop = chatBox.scrollHeight;

    // --- 1. WEBSOCKET LOGIC ---
    // --- 1. WEBSOCKET LOGIC ---
    // --- 1. WEBSOCKET LOGIC ---
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        // Check server flag 'is_me'
        const isMe = data.is_me;

        const div = document.createElement("div");
        div.className = `message-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
        
        // Time Formatting
        const date = new Date(data.timestamp || Date.now());
        const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let html = "";
        
        // --- SENDER HEADER LOGIC ---
        if (isMe) {
            // CASE 1: IT IS ME
            if (data.is_anonymous) {
                // I sent this anonymously -> Show "You (Anonymous)" label
                html += `
                <div class="d-flex align-items-center gap-1 mb-1" style="font-size: 0.75rem; opacity: 0.9; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 2px;">
                    <i class="bi bi-eye-slash-fill"></i> <strong>You (Anonymous)</strong>
                </div>`;
            }
        } else {
            // CASE 2: IT IS SOMEONE ELSE
            if (data.is_anonymous || data.sender === "Anonymous") {
                // They are anonymous -> Show "Anonymous" label
                html += `<div class="sender-name text-muted"><i class="bi bi-incognito"></i> Anonymous</div>`;
            } else {
                // Real Name
                html += `<div class="sender-name">${data.sender}</div>`;
            }
        }

        // MESSAGE CONTENT
        html += `${data.message.replace(/\n/g, '<br>')}`;
        html += `<div class="text-end opacity-75" style="font-size: 0.7rem; margin-top: 4px;">${timeStr}</div>`;
        
        div.innerHTML = html;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    // --- 2. SEND MESSAGE LOGIC ---
    function sendMessage() {
        const message = input.value.trim();
        if (message) {
            socket.send(JSON.stringify({ 
                'message': message,
                'is_anonymous': isAnonymous 
            }));
            input.value = '';
        }
    }

    // --- 3. ANONYMOUS TOGGLE ---
    function toggleAnon() {
        isAnonymous = !isAnonymous;
        
        if (isAnonymous) {
            anonBtn.classList.add('active');
            anonIcon.classList.remove('bi-eye-fill');
            anonIcon.classList.add('bi-eye-slash-fill');
            input.placeholder = "Type anonymously...";
        } else {
            anonBtn.classList.remove('active');
            anonIcon.classList.remove('bi-eye-slash-fill');
            anonIcon.classList.add('bi-eye-fill');
            input.placeholder = "Type a message...";
        }
    }

    // --- 4. VOICE LOGIC ---
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'en-IN'; 
        recognition.interimResults = false;
        recognition.continuous = false;

        recognition.onstart = () => {
            listening = true;
            micBtn.classList.add("listening");
            micBtn.innerHTML = '<i class="bi bi-stop-fill"></i>'; 
        };

        recognition.onresult = (event) => {
            const spoken = event.results[0][0].transcript;
            input.value = spoken; 
        };

        recognition.onend = () => {
            stopSpeech();
        };

        recognition.onerror = (event) => {
            console.error("Speech Error:", event.error);
            stopSpeech();
        };
    } else {
        if(micBtn) micBtn.style.display = 'none';
    }

    function toggleSpeech() {
        if (!recognition) return;
        if (!listening) {
            recognition.start();
        } else {
            recognition.stop();
        }
    }

    function stopSpeech() {
        listening = false;
        if(micBtn) {
            micBtn.classList.remove("listening");
            micBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
        }
    }

    // --- 5. EVENT LISTENERS ---
    if(btn) {
        btn.onclick = sendMessage;
        input.onkeyup = function(e) {
            if (e.keyCode === 13) sendMessage();
        };
    }
    
    // Attach click listeners to buttons explicitly if needed
    if(anonBtn) anonBtn.onclick = toggleAnon;
    if(micBtn) micBtn.onclick = toggleSpeech;

</script>
{% endblock %}